$(document).ready(function(){date=(new Date).toLocaleDateString("en-GB",{timeZone:"America/Bogota"});fecha_hoy=date.split("/").reverse().join("-");document.getElementById("txtFecha").value=fecha_hoy;cargarRangoFechas();document.getElementById("txtCompra").setAttribute("min",1);document.getElementById("compraTooltip").innerHTML="0.00 COP";document.getElementById("txtTasaIntCte").setAttribute("min",1);document.getElementById("txtCuotas").setAttribute("min",1);document.getElementById("txtCuotas").setAttribute("max",36);document.getElementById("totalPagado").innerHTML="0.00 COP";document.getElementById("interesesPagados").innerHTML="0.00 COP";let llenar_tabla="";llenar_tabla+=`<tr><th scope="row">0</th><td>00/00/0000</td><td>0.00</td><td>0.00</td><td>0.00</td><td>0.00</td><td>0.00</td></tr>`;document.getElementById("tabla_cuotas").innerHTML=llenar_tabla});function cargarRangoFechas(){let firstItemArray=db_periodos[0].periodo;let lastItemArray=db_periodos[db_periodos.length-1].periodo;let date=new Date(firstItemArray);let firstDay=new Date(date.getFullYear(),date.getMonth(),1);let primerDiaMes=firstDay.toISOString().slice(0,10);document.getElementById("txtFecha").setAttribute("min",primerDiaMes);document.getElementById("txtFecha").setAttribute("max",lastItemArray)}function validarFecha(){let fecha=document.getElementById("txtFecha").value;let firstItemArray=db_periodos[0].periodo;let lastItemArray=db_periodos[db_periodos.length-1].periodo;let date=new Date(firstItemArray);let firstDay=new Date(date.getFullYear(),date.getMonth(),1);let primerDiaMes=firstDay.toISOString().slice(0,10);if(fecha<primerDiaMes){document.getElementById("txtFecha").value=primerDiaMes;return primerDiaMes}else if(fecha>=primerDiaMes&&fecha<=lastItemArray){document.getElementById("txtFecha").value=fecha;return fecha}else{document.getElementById("txtFecha").value=lastItemArray;return lastItemArray}}function mostrarMilesCompra(value){let result=new Intl.NumberFormat("de-DE",{style:"currency",currency:"COP",maximumFractionDigits:2}).format(value);if(!isNaN(value)&&value<1){document.getElementById("compraTooltip").innerHTML="0.00 COP"}else{document.getElementById("compraTooltip").innerHTML=result}}function validarCompra(){let compra=parseFloat(document.getElementById("txtCompra").value);if(!isNaN(compra)&&compra<1){document.getElementById("txtCompra").value=1;return compra=1}else if(!isNaN(compra)){document.getElementById("txtCompra").value=compra;return compra}}function validarTasaIntCte(){let interes_mensual=parseFloat(document.getElementById("txtTasaIntCte").value);if(!isNaN(interes_mensual)&&interes_mensual<1){document.getElementById("txtTasaIntCte").value="1.00";return interes_mensual="1.00"}else if(!isNaN(interes_mensual)){document.getElementById("txtTasaIntCte").value=interes_mensual;return interes_mensual}}function validarCuotas(fecha){let cuotas=parseInt(document.getElementById("txtCuotas").value);if(!isNaN(cuotas)&&(cuotas>=1&&cuotas<=36)||cuotas>36){let contpos=0;for(let el of db_periodos){let mesAnioFecha=fecha.slice(0,7);let mesAnioPeriodo=el.periodo.slice(0,7);if(mesAnioFecha===mesAnioPeriodo){break}contpos=contpos+1}let tamano_array=db_periodos.length;let posiciones_disponibles_array=contpos;let me_puedo_mover=tamano_array-posiciones_disponibles_array;if(cuotas>=me_puedo_mover){document.getElementById("txtCuotas").value=me_puedo_mover;return me_puedo_mover}else{document.getElementById("txtCuotas").value=cuotas;return cuotas}}else if(!isNaN(cuotas)){document.getElementById("txtCuotas").value=1;return cuotas=1}}function calculadora_rappicard(){let fecha=validarFecha();let compra=validarCompra();let interes_mensual=validarTasaIntCte();let cuotas=validarCuotas(fecha);if(!isNaN(compra)&&!isNaN(interes_mensual)&&!isNaN(cuotas)){let llenar_tabla="";let intereses_pagados=0;let suma_total_cuotas=0;cuota_a_devolver=compra/cuotas;deuda_total=compra-cuota_a_devolver;if(deuda_total<0){deuda_total_fix=0}else{deuda_total_fix=deuda_total}let intereses=compra*(interes_mensual/100);let contpos=0;for(let el of db_periodos){let mesAnioFecha=fecha.slice(0,7);let mesAnioPeriodo=el.periodo.slice(0,7);if(mesAnioFecha===mesAnioPeriodo){if(fecha>el.periodo){contpos=contpos+1;fecha_cobro_mes_1=db_periodos[contpos].periodo;interes_diario_mes_1=intereses/el.dias_calendario_periodo_fecha_cobro;break}else{fecha_cobro_mes_1=el.periodo;interes_diario_mes_1=intereses/el.dias_calendario_periodo_fecha_cobro;break}}contpos=contpos+1}let diff=diffFechas(fecha,fecha_cobro_mes_1);let dias_antes_del_corte=diff;if(cuotas===1){prorateo_interes_mes_1=0}else{prorateo_interes_mes_1=interes_diario_mes_1*dias_antes_del_corte}cuota=cuota_a_devolver+prorateo_interes_mes_1;let p=fecha_cobro_mes_1.split(/\D/g);fecha_cobro_mes_1=[p[2],p[1],p[0]].join("/");let compra_tabla=new Intl.NumberFormat("de-DE",{maximumFractionDigits:2}).format(compra);let cuota_a_devolver_tabla=new Intl.NumberFormat("de-DE",{maximumFractionDigits:2}).format(cuota_a_devolver);let prorateo_interes_mes_1_tabla=new Intl.NumberFormat("de-DE",{maximumFractionDigits:2}).format(prorateo_interes_mes_1);let cuota_tabla=new Intl.NumberFormat("de-DE",{maximumFractionDigits:2}).format(cuota);let deuda_total_fix_tabla=new Intl.NumberFormat("de-DE",{maximumFractionDigits:2}).format(deuda_total_fix);llenar_tabla+=`<tr><th scope="row">1</th><td>`+fecha_cobro_mes_1+`</td><td>`+compra_tabla+`</td><td>`+cuota_a_devolver_tabla+`</td><td>`+prorateo_interes_mes_1_tabla+`</td><td>`+cuota_tabla+`</td><td>`+deuda_total_fix_tabla+`</td></tr>`;deuda_total_aux=deuda_total;for(let i=1;i<cuotas;i++){contpos=contpos+1;let cuota_a_devolver=compra/cuotas;let interes_neto=deuda_total_aux*(interes_mensual/100);let month=new Date(db_periodos[contpos].periodo).getMonth()+1;let year=new Date(db_periodos[contpos].periodo).getFullYear();let days_in_month=new Date(year,month,0).getDate();let interes_diario=interes_neto/days_in_month;let intereses=interes_diario*db_periodos[contpos].dias_calendario_periodo_fecha_cobro;let cuota=cuota_a_devolver+intereses;let deuda_total=deuda_total_aux-cuota_a_devolver;if(deuda_total<0){deuda_total_fix=0}else{deuda_total_fix=deuda_total}let p=db_periodos[contpos].periodo.split(/\D/g);let fecha_cobro_mes=[p[2],p[1],p[0]].join("/");let deuda_total_aux_tabla=new Intl.NumberFormat("de-DE",{maximumFractionDigits:2}).format(deuda_total_aux);let cuota_a_devolver_tabla=new Intl.NumberFormat("de-DE",{maximumFractionDigits:2}).format(cuota_a_devolver);let intereses_tabla=new Intl.NumberFormat("de-DE",{maximumFractionDigits:2}).format(intereses);let cuota_tabla=new Intl.NumberFormat("de-DE",{maximumFractionDigits:2}).format(cuota);let deuda_total_fix_tabla=new Intl.NumberFormat("de-DE",{maximumFractionDigits:2}).format(deuda_total_fix);llenar_tabla+=`<tr><th scope="row">`+(i+1)+`</th><td>`+fecha_cobro_mes+`</td><td>`+deuda_total_aux_tabla+`</td><td>`+cuota_a_devolver_tabla+`</td><td>`+intereses_tabla+`</td><td>`+cuota_tabla+`</td><td>`+deuda_total_fix_tabla+`</td></tr>`;deuda_total_aux=deuda_total;intereses_pagados=intereses_pagados+intereses;suma_total_cuotas=suma_total_cuotas+cuota}total_pagado=compra+intereses_pagados+prorateo_interes_mes_1;intereses_pagados_totales=intereses_pagados+prorateo_interes_mes_1;let total_pagado_frontend=new Intl.NumberFormat("de-DE",{style:"currency",currency:"COP",maximumFractionDigits:2}).format(total_pagado);let intereses_pagados_totales_frontend=new Intl.NumberFormat("de-DE",{style:"currency",currency:"COP",maximumFractionDigits:2}).format(intereses_pagados_totales);document.getElementById("totalPagado").innerHTML=total_pagado_frontend;document.getElementById("interesesPagados").innerHTML=intereses_pagados_totales_frontend;document.getElementById("tabla_cuotas").innerHTML=llenar_tabla}else{document.getElementById("totalPagado").innerHTML="0.00 COP";document.getElementById("interesesPagados").innerHTML="0.00 COP";let llenar_tabla="";llenar_tabla=`<tr><th scope="row">0</th><td>00/00/0000</td><td>0.00</td><td>0.00</td><td>0.00</td><td>0.00</td><td>0.00</td></tr>`;document.getElementById("tabla_cuotas").innerHTML=llenar_tabla}}function diffFechas(fechaInicio,fechaFin){let dt1=new Date(fechaInicio);let dt2=new Date(fechaFin);let result=Math.floor((Date.UTC(dt2.getFullYear(),dt2.getMonth(),dt2.getDate())-Date.UTC(dt1.getFullYear(),dt1.getMonth(),dt1.getDate()))/(1e3*60*60*24));return result}
